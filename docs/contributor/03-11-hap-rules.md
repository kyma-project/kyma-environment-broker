# HAP Rule Configuration

> [!NOTE]
> This feature is still being developed and will be available soon.

The Hyperscaler Account Pool (HAP) Rule Configuration is a functionality that allows to control pool selection from a configurable helm property. 
A pool is a set of Gardener's SecretBinding resources that share the same search labels. 
Pool selection is a process that decides on which SecretBinding pool is the most suitable to use for every SKR creation request.
The process generates a list of [search labels](#search-labels) based on SKR's attributes.

The [search labels](#search-labels) are used to query Gardener's secret bindings.
[search labels](#search-labels) are generated by evaluating a rule consisting of rule entries and if an entry applies to the request then the rule outputs its specific [search labels](#search-labels) to query the correct pool.
More about HAP process can be found in [Hyperscaler Account Pool](03-10-hyperscaler-account-pool.md) document.

![Rules Evaluation Process](../assets/hap-rules-general.drawio.svg)

## Rule Configuration

The rule is configured in values.yaml in `hap.rule` property.
It is a list of strings, each of which is a single rule entry that corresponds to a single pool.
Each rule entry is evaluated during cluster provisioning process.
If more than one rule applies the best matching rule is selected based on the [priority](#uniqnuess--priority). The following examples presents example configuration in values.yaml:

```
hap: 
  rule: 
  - rule_entry_1
  - rule_entry_2
  ...
  - rule_entry_n
```

Every pool that a rule entry represents must be preconfigured in a Gardener cluster that KEB connects to.

## Rule Format 

The following example shows the Rule Entry format:

```
PLAN(INPUT_ATTR_1=VAL_1, INPUT_ATTR_2=VAL_2, ..., INPUT_ATTR_N=VAL_N) -> OUTPUT_ATTR_1, OUTPUT_ATTR_2, ..., OUTPUT_ATTR_M
```

Every rule entry consists of input and output attributes separated by the arrow symbol - `->`.
Input attributes are used to match rule entry with the SKR request and to modify [search labels](#search-labels). Output attributes are only used to modify the [search labels](#search-labels).
In its minimal form each rule consists of a `PLAN` that the rule applies to.
In its extended form a rule entry contains lists of input attributes and its values passed in the form of `ATTR=VAL` pairs in parantheses.

> ![NOTE]
> The following rule entries are considered valid and the same:
> * `aws`
> * `aws()`

Output attributes does not support values.
Description of when the rule is triggered can be found in the [Rule Evaluation](#evaluation) section.
Rule attributes are described in [Rule Attributes](#rule-attributes) section. 

Currently, possible OUTPUT_ATTR_x attributes values are `S` or `EU`.

```
hap: 
  rule: 
  - azure(INPUT_ATTR_1=VAL_1,INPUT_ATTR_2=VAL_2,...,INPUT_ATTR_N) -> OUTPUT_ATTR_1=VAL_1,OUTPUT_ATTR_2=VAL_2,...,OUTPUT_ATTR_M
```

The input attribute types include **platformRegion** (`PR`) and **hyperscalerRegion** (`HR`). The output attribute types include **shared** (`S`) and **euAccess** (`EU`). 
Each attribute can be used at most once in a single rule entry.
**shared** and **euAccess** attributes are used only to apply their labels if rest of matched attributes are equal to SKR's values. 

## Rule Evaluation

HAP evaluates a set of rules to determine what labels to use when querying secret bindings.
Rule is evaluated during cluster provisioning. Rule entries are analyzed one by one.
Input attributes from every entry are compared with values from SKR input. If they are the same then the rule entry is considered matched.
If there is more than one triggered rule then only one is selected in accordance to priority rules described in the [Priority](#priority) section.
If there are no rule entries trigered then the error is returned. No fallback behaviour is defined in such case.



## Search Labels

HAP stores credentials to hyperscaler accounts in Kubernetes Secrets that SecretBindings points to. KEB searches for SecretBindings using labels **hyperscalerType**, **shared** and **euAccess**. 

The **hyperscaler-type** contains hyperscaler name and region information in the format of `hyperscaler_type: <HYPERSCALER_NAME>[_<PLATFORM_REGION>][_<HYPERSCALER_REGION>]`, where both `_<PLATFORM_REGION>` and `_<HYPERSCALER_REGION>` are optional. The **hypercaler-type** label is mandatory. Its value is computed based on a plan and regions and mapped in [hyperscaler_type.go](https://github.com/kyma-project/kyma-environment-broker/blob/main/common/hyperscaler/hyperscaler_type.go). Not all plans share their name with hyperscaler types, e.g. sap-converged-plan has `openstack` hyperscalerType and `trial` plan can have either `azure` or `aws` depending on the configured provider type. 

The following table shows a mapping of plans to hyperscaler types:

| Plan                	| Hyperscaler Type 	|
|---------------------	|------------------	|
| azure               	| azure            	|
| azure_lite          	| azure            	|
| aws                 	| aws              	|
| gcp                 	| gcp              	|
| preview             	| aws              	|
| sap-converged-cloud 	| openstack       	|
| trial               	| aws              	|

The **euAccess** and **shared** labels contain boolean values and they are used to divide existing pools to secrets used by EU restricted regions and secrets shared by multiple Global Accounts. The **euAccess** and **shared** labels are optional.

Every rule must contain at least a plan and apply `hyperscaler_type: <HYPERSCALER_NAME>` label. The following example shows a simple rule entry configuration and a SecretBinding pool that this configuration corresponds to:

```
hap:
  rule:
    - gcp                             # pool: hyperscalerType: gcp
```

Rest of examples in the document follow the same structure of presenting a configuration and its corresponding pools in the comment as the snippet above.

## Rule Attributes

Existence of an attribute in a rule means a set of clusters it applies to is constrained not only by a plan but by the attribute itself. The following section describes attributes that can be used in rule entries.

### Platform Region Attribute

It is possible to extend a rule entry with specified platform region by adding  a `PR` rule attribute. If an actual value of SKR's platform region attribute matches the PR rule attribute then `hyperscalerType: <HYPERSCALER_NAME>[_<PLATFORM_REGION>]` label is used.

Below configuration means that if a gcp cluster is provisioned in cf-sa30 platform region, then KEB would search for secret bindings with `hyperscalerType: gcp_cf-sa30` label. 

```
hap: 
  rule: 
    - gcp(PR=cf-sa30)                 # pool: hyperscalerType: gcp_cf-sa30
```

### Hyperscaler Region Attribute

A region that an SKR is provisioned in can be matched with an attribute named `HR`. Below configuration specifies the azure plan as one for which to use hyperscaler region based search. In this case, cluster provisioned with the azure plan would require a secret binding with `hyperscalerType: azure_<HYPERSCALER_REGION>` label. 

```
hap: 
  rule: 
    - gcp(HR=us-central1)             # pool: hyperscalerType: gcp_us-central1,
```

### Shared & EU Access attribute

The `shared` and `euAccess` attributes does not correspond to any SKR's property. Those atributes are only used to add search labels. If the rule entry contains `shared` or `euAccess` attributes then when triggered, a `shared: true` or `euAccess: true` labels are added to the [search labels](#search-labels). Shared label on a SecretBindings marks it as assignable to more than one SKR and euAccess is used to mark EU regions (more on that can be found in [HAP Pool document](03-10-hyperscaler-account-pool.md)). Below configuration specifies that all gcp clusters will use the same pool of shared secret bindings marked with labels `hyperscalerType: gcp`, `shared: true` and azure clusters in the region cf-ch20 will use a pool of secret bindings marked with labels `hyperscalerType: azure`, `euAccess: true`.

```
hap: 
  rule: 
    - gcp -> S                        # pool: hyperscalerType: gcp; shared: true 
    - azure(PR=cf-ch20) -> EU          # pool: hyperscalerType: azure_cf-ch20, euAccess: true
```

### Attribute with "*"

Input attributes' values can be replaced with `*`, which means that all SKR's values of that attribute are matched and used when creating [search labels](#search-labels). For example, the following configuration makes KEB search for SecretBindings with `hyperscalerType: gcp_<PR>`, where `PR` corresponds to an SKR value, for all `gcp` clusters:

```
hap: 
  rule: 
  - gcp(PR=*)                         # pool: hyperscalerType: gcp_cf-sa30
                                      # pool: hyperscalerType: gcp_cf-jp30
```

The attributes that support `*` are: `PR`, `HR`.

> ![NOTE]
> The above configuration example effectively disables usage of SecretBindings labeled only with `hyperscalerType: gcp`.



### Atributes Summary

The following table summarizes the attributes that can be used in the rule entry. Its columns define:
* Name and symbol - the latter is used in rule entries.
* Data type and possible values.
* Input attributes - true when the attribute can occur in the input attributes section (left part) of a rule entry (see [Rule Format](#rule-format) section).
* Output attributes - true when the attribute can occur in the output attributes section (right part) of a rule entry (see [Rule Format](#rule-format) section).
* Modified SecretBinding search labels - lists modifications of search labels that the rule entry containing the attribute adds to search labels if triggered. 

| Name (Symbol)        	| Data Type and Possible Values                                                                                                                    	| Input Attribute 	| Output Attribute 	| Modified SecretBinding Search Labels                                                              	|
|----------------------	|------------------------------------------------------------------------------------------------------------------------------------	|-----------------	|------------------	|---------------------------------------------------------------------------------------------------	|
| Platform Region (PR) 	| string, platform regions as defined in https://help.sap.com/docs/btp/sap-business-technology-platform/regions-for-kyma-environment 	| true            	| false            	| hyperscalerType: `<providerType>_<PR>` or hyperscalerType: `<providerType>_<PR>_<HR>` if used with HR 	|
| Hyperscaler Region (HR)  	| string, hyperscaler region as defined in https://help.sap.com/docs/btp/sap-business-technology-platform/regions-for-kyma-environment   	| true            	| false            	| hyperscalerType: `<providerType>_<HR>` or hyperscalerType: `<providerType>_<PR>_<HR>` if used with PR 	|
| Eu Access (EU)       	| no value                                                                                                                           	| false           	| true             	| euAccess: true                                                                                    	|
| Shared (S)           	| no value                                                                                                                           	| false           	| true             	| shared: true                                                                                      	|

## Uniqnuess & Priority

Only one rule can be triggered. If more than one rule entry match the request then only one is selected and applied. The process of selecting the best matching rule is based on a rule uniqueness and priority.
Rule entry uniqueness is determined by its plan and input parameters with its values (identification attributes) not including input parameters with `*`. 
Output parameters are not taken into account when establishing rule entry uniqueness. For example the following rule will fail on startup because every SKR can be matched by both rules:

```
hap:
  rule: 
    - gcp 
    - gcp -> S                      # invalid entry, output attributes does not take part into uniqnuess check
    - gcp(PR=*)                     # invalid entry, both can be applied to the same skr
    - gcp(HR=europe-west3)          # valid entry, new HR attribute makes the rule unique
    - gcp(PR=*, HR=europe-west3)    # invalid rules, the same as previous one because of addition of `PR=*` attribute
```

Rule configuration must contain only unique entries in the scope of that list.
If rule configuration contains duplicated rule entries an error that fails KEB startup is returned.

Rule entry priority is selected by sorting all rule entries that apply to the request by the number of identification attributes they contain. 
For example, a rule with no attributes and only a plan has lower priority then a rule with the same plan but a platform region attribute (`gcp` < `gcp(PR=cf-sa30)`).
After sorting the entry that specifies most attributes (hence is the most specific) is selected. 
Input attributes with value `*` are not taken into account when calculating priority.

The following example shows priority of rules starting from the lowest priority:

```
aws -> S                              # search labels: hyperscalerType: aws, shared: true
aws(PR=cf-eu11) -> EU                 # search labels: hyperscalerType: aws_cf-eu11, euAccess: true
aws(PR=cf-eu11, HR=westeu) -> EU, S   # search labels: hyperscalerType: aws_cf-eu11_westeu, shared: true, euAccess: true
```

## Validation

KEB validates HAP Rules during startup. If the configuration is invalid, KEB will not start and an error message will be displayed in the logs. 

The constraints used for validation during KEB startup include:
* Rules format check - all the rules must comply with the format specified above.
* Every supported plan needs at least one rule entry, if no rule entry is defined for a plan then an error is returned during KEB startup.
* Uniqueness validation check - KEB checks if all rule entries are unique in the scope of the rule. Specifying more than one entry with the same number of identification attributes is prohibited. If more than one such attribute is specified then the error is returned failing KEB startup. For more details see [Uniqnuess & Priority](#uniqnuess--priority) section. 


## Initial Configuration

The last example shows initial configuration created to mimic the current bahaviour of KEB at the time of writing the document. The configuration enforces that:
* azure, aws, gcp have their own pools of dedicated bindings.
* gcp clusters in the region cf-sa30 use the pool of secret bindings marked with labels: `hyperscalerType: gcp_cf-sa30`,
* sap-converged-cloud clusters use the pool of secret bindings marked with labels: `hyperscalerType: openstack_<HYPERSCALER_REGION>` and all these pools are shared.
* trial clusters can use one of two pools of shared secret bindings marked with labels: `hyperscalerType: azure` or `hyperscalerType: aws` depending on the used trial provider type.
* azure clusters in the region cf-ch20 and aws clusters in the region cf-eu11 have their own dedicated pools and are euAccess specific.

```
hap:
 rule: 
  - aws                             # pool: hyperscalerType: aws
  - aws(PR=cf-eu11) -> EU           # pool: hyperscalerType: aws_cf-eu11; euAccess: true 
  - azure                           # pool: hyperscalerType: azure
  - azure(PR=cf-ch20) -> EU         # pool: hyperscalerType: azure_cf-ch20; euAccess: true 
  - gcp                             # pool: hyperscalerType: gcp
  - gcp(PR=cf-sa30)                 # pool: hyperscalerType: gcp_cf-sa30
  - trial -> S                      # pool: hyperscalerType: azure; shared: true - TRIAL POOL
                                    # pool: hyperscalerType: aws; shared: true - TRIAL POOL 
  - sap-converged-cloud(HR=*) -> S  # pool: hyperscalerType: openstack_<HYPERSCALER_REGION>; shared: true
  - azure_lite                      # pool: hyperscalerType: azure
  - preview                         # pool: hyperscalerType: aws
```
