# HAP Rule Configuration

 The Hyperscaler Account Pool (HAP) Rule Configuration is a functionality that allows to control pool selection from a configurable helm property. 
 The HAP pool is a set of Gardener's SecretBindings K8S resources that share the same labels. 
 The HAP Pool Selection is a process that for every skr creation request decides on which secret binding is the most suitable to use. 
 The process generates a list of search labels based on skr's physical and logical attributes.
 The search labels are used to query Gardener's Secret Bindings. 
 Search labels are generated by evaluating a Rule consisting of Rule Entries and if an Entry applies to the request then the Rule outputs its specific search labels to query the correct HAP Pool.
 More about HAP process can be found in [Hyperscaler Account Pool](03-10-hyperscaler-account-pool.md) document.

![Rules Evaluation Process](../assets/hap-rules-general.drawio.svg)

## Rule Configuration

The Rule is configured in values.yaml in `hap.rule` property.
It is is a list of strings, each of which is a single Rule Entry that corresponds to a single HAP Pool. 
Each Rule Entry is evaluated during a cluster provisioning process.
If more than one rule applies the best matching rule is selected based on the rule [priority](#priority). The following examples presents the Rule Configuration in values.yaml:

```
hap: 
  rule: 
  - rule_1
  - rule_2
  ...
  - rule_n
```

Every HAP Pool that the Rule Entry represents must be preconfigured in a Gardener Cluster that KEB connects to.

## Rule Format 

The following example shows the Rule Entry format:

```
PLAN(ATTR_1=VAL_1,ATTR_2=VAL_2,...,ATTR_N)
```

In its minimal form each rule consists of a `PLAN` that the rule applies to.
The rule can be extended with a list of attributes and its values passed in the form of `ATTR=VAL` pairs.
Description of when the rule is triggered can be found in the [Rule Evaluation](#evaluation) section.
List of possible attributes is described in the [Rule Attributes](#rule-attributes) section.

## Rule attributes

```
hap: 
  rule: 
  - azure(ATTR_1=VAL_1,ATTR_2=VAL_2,...,ATTR_N)
```

```
SecretBinding pools:
- hyperscalerType: azure, ATTR_1: VAL_1, ATTR_2: VAL_2, ..., ATTR_N: VAL_N
```

- extended expresions alter the search query by addition different properties
- physical vs logical

Existence of an attribute in the rule means its inclusion in the search label. If a have a triggered rule without attributes than this attribute is not included in the query.

- attributes: plan, platformRegion, clusterRegion, shared, euAccess
- physical vs logical

### Attribute with "*"

```
hap: 
  rule: 
  - plan(ATTR_1=*)
```

```
SecretBinding pools:
- hyperscalerType: plan, ATTR_1: VAL_1
- hyperscalerType: plan, ATTR_1: VAL_2
- hyperscalerType: plan
```
- extended expresions alter the search query by addition different properties

Existence of an attribute in the rule means its inclusion in the search label. If a have a triggered rule without attributes than this attribute is not included in the query.

- attributes: plan, platformRegion, clusterRegion, shared, euAccess


### Platform Region Attribute

It is possible to extend the configuration rule entry with specified platform region. Below configuration means that if a gcp cluster is provisioned in cf-sa30 subaccount region then KEB would search for secret bindings with `hyperscalerType: gcp_cf-sa30` label. In other cases, for example when probisioning a gcp cluster.

```
hap: 
  rule: 
    - gcp(PR=cf-sa30)

SecretBinding pools
- hyperscalerType: gcp_cf-sa30, 
```

- list of platform regions is here: ...
- platform region supports * as a wildcard

The following configuration is an example of a rule that appends the platform region to the `hyperscaler-type` label when searching for secrets for all gcp clusters. The configuration means that there would be no possibillity to configure a pool with label `hyperscalerType: gcp` since KEB would search for `hyperscalerType: gcp_<PLATFORM_REGION>` bindings only.

```
hap: 
  rule: 
  - aws(PR=*)

SecretBinding pools
- hyperscalerType: aws_PLATFOR_REGION, 
```

TODO: note that we have removed gcp pool at all

TODO: An example should explain rules priority, how plan translates to hyperscaler account type (sap-converged-cloud -> openstack) and what asterix means

### Cluster Region Attribute

All the configuration rules are independent of each other from the point of view of their configuration. If the same plan/region pair appears in more than one property, then all the rules that it appears in take effect. Below configuration specifies that for all gcp clusters the search should be done based on platform region and cluster region searches. The resulting search label would be `hyperscalerType: gcp_<PLATFORM_REGION>_<CLUSTER_REGION>`.

```
hap: 
  rule: 
    - gcp(CR=us-central1)

SecretBinding pools
- hyperscalerType: gcp_us-central1, 
```

- cluster region supports * as a wildcard

Below configuration specifies azure plan as one for which to use cluster region based search. In this case, cluster provisioned in with the azure plan would require a secret binding with `hyperscalerType: azure_<CLUSTER_REGION>` label. All of the rule examples apply all of platformRegionRule, clusterRegionRule, shareRule and euAccessRule properties.

```
hap: 
  rule:
    - gcp(CR=*)

TODO: make the section based on the specific region instead of an *

SecretBinding pools
- hyperscalerType: gcp_us-central1, 
- hyperscalerType: gcp_europe-west3, 
```

### Shared attribute

```
hap: 
  rule:
    - gcp(CR=*)

TODO: make the section based on the specific region instead of an *

SecretBinding pools
- hyperscalerType: gcp_us-central1, shared: true
- hyperscalerType: gcp_europe-west3, 
```

### Atribute and non-attribute rules

Differently than in previous example, in this case, it is possible to configure two different pools for the same hyperscaler type.

```
hap: 
  rule: 
    - gcp(PR=cf-sa30)
    - gcp

SecretBinding pools
- hyperscalerType: gcp_cf-sa30, 
- hyperscalerType: gcp, 
```

- Priority takes place
- refer to the priority section
- the first pool will be selected only if the cluster is provisioned in the cf-sa30 region
- all the other clusters will use the second pool


### Multiple Attributes in One Rule Entry


### Pools Divided per Attribute

As stated previously, it is possible to include multiple elements in each configuration rule. The example below shows how to configure multiple plan/region pairs for based on platformRegionRule. The same can be configured for all other rules (clusterRegionRule, sharedRule, euAccessRule). The list below allows to KEB to operate on 3 pools for gcp plan: one withouth a region, one for cf-sa30 region and one for cf_jp30 region; 2 pools for aws plan: one without a region and one for cf_eu11 region; multiple pools for openstack plan - all with a platform region specified; and one pool for azure without a platform region.

```
hap: 
  rule:
    - azure
    - aws
    - aws(PR=cf-eu11)
    - gcp
    - gcp(PR=cf-sa30)
    - gcp(PR=cf-jp30)
    - sap-converged-cloud

SecretBinding pools
- hyperscalerType: azure, 
- hyperscalerType: aws, 
- hyperscalerType: aws_cf-eu11, 
- hyperscalerType: gcp, 
- hyperscalerType: gcp_cf-sa30, 
- hyperscalerType: gcp_cf-jp30, 
- hyperscalerType: openstack, 
```



### Multiple Attributes in the same rule

```
hap: 
  rule:
  - gcp(CR=*, PR=*)
  - azure
  - aws
  - sap-converged-cloud

SecretBinding pools:
- hyperscalerType: azure
- hyperscalerType: aws
- hyperscalerType: gcp_<PLATFORM_REGION>_<CLUSTER_REGION>
- hyperscalerType: openstack
```



`sharedRule` and `euAccessRule` are idependent but in contrast to `platformRegionRule` and `clusterRegionRule` if they are both evaluated to true the search label contains two additional labels `shared: true` and `euAccess: true`. Instead of modifying the same label value `hyperscalerType` two additional labels are added to the same query. In the example below, all gcp clusters will use the same pool of secret bindings marked with labels: `hyperscalerType: gcp_<PLATFORM_REGION>_<CLUSTER_REGION>`, `shared: true`, `euAccess: true`.

```
hap: 
  rule:
  - azure
  - aws
  - gcp(CR=*, PR=*, euAccess=true, shared=true)
  - sap-converged-cloud

SecretBinding pools:
- hyperscalerType: azure, 
- hyperscalerType: aws, 
- hyperscalerType: gcp, 
- hyperscalerType: gcp_<PLATFORM_REGION>_<CLUSTER_REGION>, 
...
- hyperscalerType: openstack, 
```

TODO: region/platform variations

## Rule Evaluation

HAP evaluates a set of rules to determine what labels to use when querying secret bindings.
Input to the rules consists of an SKR's physical attributes **plan**, **hyperscalerRegion** and **clusterRegion**.
Rules are evaluated during cluster provisioning.
Rule entries are analyzed one by one.
Attributes from every entry are compared with values from input, if they are the same the rule entry is considered triggered - in order for the rule to be triggered its plan and attributes must match what is passed in the request.
If there is more than one triggered rule then only one is selected in accordance to priority rules described in the [Priority](#priority) section.
If there are no rule entries trigered then the error is returned. No fallback behaviour is defined in such case.
Triggered rule entry applies its specific labels to the SecretBinding search query.

## Priority

Only one rule can be triggered.
If more than one rule entry match the request than only one is selected by sorting them by the number of attributes they contain.
The entry that specifies most attributes (hence is more specific) is selected.
If there are more than one rule with the same number of attributes then an error is returned.

## Search Labels

The HAP stores credentials for the hyperscaler accounts that have been set up in advance in Kubernetes Secrets that the Secret Bindings, that KEB searches for, point to. The SecretBindings are labeld with **hyperscalerType**, **shared**, **euAccess** labels.

The **hyperscaler-type** contains hyperscaler name and region information in the format `hyperscaler_type: <HYPERSCALER_NAME>[_<PLATFORM_REGION>][_<HYPERSCALER_REGION>]`, where both `_<PLATFORM_REGION>` and `_<HYPERSCALER_REGION>` are optional. 

The **hypercaler-type** label is mandatory.

The **euAccess** and **shared** labels contain boolean values and they used to divide existing pools to secrets used by EU restricted regions and secrets shared by multiple Global Accounts. 

The **euAccess** and **shared** labels are optional

## Validation

KEB validates HAP Rules during startup.

If the configuration is invalid, KEB will not start and an error message will be displayed in the logs. 

The constraints used for validation include:
* Rules format check - all the rules must comply with the format specified above.
* Every rule Entry must refer to an existing plan.
* Every Rule Entry must refer to an existing pool.

TODO: if pool validation is necessary describe its algorithm



## Simple Rules

```
hap: 
  rule: 
  - azure
  - gcp

SecretBinding pools:
- hyperscalerType: azure,
- hyperscalerType: gcp,
```

Described:
- you defined rules by listing plans 
- plan will be translated to search labels
- in the basic form rule contains plan but is translated to hyperscalerType search label in this case 
- you can pass more than one rule in the list

## Pools Misconfiguration

```
hap: 
  rule: 
  - azure
  - gcp
```

```
SecretBinding pools:
- hyperscalerType: azure,
```

- If you define a rule with non existing pools then an error is returned if a during KEB startup (more in the validation)
- all the secret bindings pools must be preconfigured in acordance to the rules

On the other hand if we configure a pool that is not used in any rule then it is not possible to select such pool. If a request comes and no rule is match the request then and error is returned.

```
hap: 
  rule: 
  - azure
```

```
SecretBinding pools:
- hyperscalerType: azure,
- hyperscalerType: gcp,
```



## Empty Pool

- Result: error, no rule configured

```
hap: 
  rule: ""
```
## Initial Configuration

The last example shows initial configuration create to mimic the current bahaviour of KEB at the time of writing the document. The configuration enforces that:
* azure, aws, gcp have their own pools of dedicated bindings.
* gcp clusters in the region cf-sa30 use the pool of secret bindings marked with labels: `hyperscalerType: gcp_cf-sa30`,
* sap-converged-cloud clusters use the pool of secret bindings marked with labels: `hyperscalerType: openstack_<CLUSTER_REGION>` and all of the are shared.
* trial clusters can use one of two pool of shared secret bindings marked with labels: `hyperscalerType: azure` or `hyperscalerType: aws` (because of hardcoded mapping of trial plan to azure or aws providers) depending on the provider type.
* azure clusters in the region cf-ch20 and aws clusters in the region cf-eu11 have their own dedicated pool.

```
hap: 
  rule:
  - azure(euAccess=*)
  - aws(euAccess=*)
  - trial(shared)
  - gcp
  - gcp(PR=cf-sa30) 
  - openstack(CR=*, shared)

  platformRegionRule: "gcp:cf-sa30"
  clusterRegionRule: "sap-converged-cloud"
  sharedRule: "trial;sap-converged-cloud"
  euAccessRule: "azure:cf-ch20;aws:cf-eu11"

TODO: rules are not restrictive - definition of a rule with "*" does not mean that all variations of pools must be created, this is the only place where validation does not take place
TODO: translation between plan and hyperscaler type

SecretBinding pools:
- hyperscalerType: azure, 
- hyperscalerType: aws, 
- hyperscalerType: gcp, 
- hyperscalerType: azure; shared: true - TRIAL POOL
- hyperscalerType: aws; shared: true - TRIAL POOL 
- hyperscalerType: azure; euAccess: true 
- hyperscalerType: aws; euAccess: true 
- hyperscalerType: gcp_cf-sa30, 
- hyperscalerType: openstack_<CLUSTER_REGION>; shared: true, 
```
---