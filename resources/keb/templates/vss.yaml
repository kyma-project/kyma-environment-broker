{{- if and .Values.global.secrets.enabled  ( eq .Values.global.secrets.mechanism "vso") }}
{{- $root := .}}
{{- $globalmount := get (get (default dict .Values.global.secrets) "vso" | default dict) "mount" }}
{{- range $sname, $secret := .Values.vsoSecrets.secrets }}
---
# {{ $globalmount }}
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultStaticSecret
metadata:
  name: {{ tpl $secret.secretName $ | required "Please supply secretName" | quote }}
  namespace: {{ get $secret "namespace" | default $root.Release.Namespace}}
spec:
  namespace: {{ $root.Values.global.secrets.vso.namespace | required "Vault namespace not set"}}
  refreshAfter: {{ get $secret "refreshAfter" | default $root.Values.global.secrets.vso.refreshAfter | default "5m" }}
  mount: {{ $secret.mount | default $root.Values.vsoSecrets.mount | default $globalmount | required "Secret mount not set" | quote }}
  path: {{ $secret.path | required "Secret path not set" | quote}}
  hmacSecretData: true
  type: kv-v2
  destination:
    create: true
    name: {{ tpl $secret.secretName $ | required "Please supply secretName" | quote }}
    labels:
      kcp.kyma-project.io/vss-release: {{ $root.Release.Name }}
      {{- if $secret.labels }}
      {{- if kindIs "map" $secret.labels  }}
      {{- $secret.labels | toYaml | nindent 6 }}
      {{- else if kindIs "string" $secret.labels  }}
      {{- tpl $secret.labels $ | nindent 6}}
      {{- else }}
      {{- fail (printf "Unknown kind %s for labels" (kindOf $secret.label))}}
      {{- end }}
      {{- end }}
    {{- if $secret.annotations }}
    annotations:
      {{- if kindIs "map" $secret.annotations  }}
      {{- $secret.annotations | toYaml | nindent 6 }}
      {{- else if kindIs "string" $secret.annotations  }}
      {{- tpl $secret.annotations $ | nindent 6}}
      {{- else }}
      {{- fail (printf "Unknown kind %s for annotations" (kindOf $secret.label))}}
      {{- end }}
    {{- end }}
    overwrite: true
    type: {{ get $secret "type" | default "Opaque" }}
    transformation:
      excludeRaw: true
      {{- if and (hasKey $secret "templating") (get $secret.templating "enabled" | default false) }}
      excludes:
        - .*
      templates:
        {{- range $fname, $fvalue := $secret.templating.data }}
        {{ $fname }}:
          {{- if hasKey $fvalue "templateFile" }}
          text: |-
            {{ tpl ($.Files.Get $fvalue.templateFile) (dict "Template" $.Template "keys" $secret.templating.keys "Values" $root.Values) | nindent 12 }}
          {{- else if hasKey $fvalue "template" }}
          text: |
            {{- tpl $fvalue.template (dict "Template" $.Template "keys" $secret.templating.keys "Values" $root.Values) | nindent 12 -}}
          {{- else if hasKey $fvalue "simpleValue" }}
          text: {{-- $fvalue.simpleValue | quote -}}
          {{- else }}
          text: |
            {{ printf "{{- get .Secrets \"%s\" -}}" (get $secret.templating.keys $fname) }}
          {{- end }}
        {{- end }}
    {{- end }}
  {{- if or (hasKey $root.Values.vsoSecrets "restartTargets") (hasKey $secret "restartTargets") }}
  rolloutRestartTargets:
    {{- range $root.Values.vsoSecrets.restartTargets }}
    - kind: {{ .kind }}
      name: {{ tpl .name $ | quote }}
    {{- end }}
    {{- range $secret.restartTargets }}
    - kind: {{ .kind }}
      name: {{ tpl .name $ | trim | quote }}
    {{- end }}
  {{- end }}
{{- end }}
{{- end }}
