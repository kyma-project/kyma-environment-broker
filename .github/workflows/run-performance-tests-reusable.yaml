name: Run performance tests (reusable)

on:
  workflow_call:
    inputs:      
      # Timing Configuration
      kim-delay-seconds:
        description: 'Time to wait before transitioning the runtime CR to the Ready state'
        default: '0'
        type: string
      provisioning-max-step-processing-time:
        description: 'Max time to process a step in provisioning queue'
        default: '30s'
        type: string
      update-max-step-processing-time:
        description: 'Max time to process a step in update queue'
        default: '30s'
        type: string
      deprovisioning-max-step-processing-time:
        description: 'Max time to process a step in deprovisioning queue'
        default: '30s'
        type: string
      baseline-monitoring-minutes:
        description: 'Duration of baseline monitoring before tests (minutes)'
        default: '2'
        type: string
      post-test-monitoring-minutes:
        description: 'Duration of post-test monitoring after tests (minutes)'
        default: '2'
        type: string

      # Test Configuration
      instances-number:
        description: 'Number of instances to be provisioned'
        default: '100'
        type: string
      updates-number:
        description: 'Number of updates on a single instance'
        default: '300'
        type: string
      
      # Workers Configuration
      provisioning-workers-amount:
        description: 'Amount of workers in provisioning queue'
        default: '200'
        type: string
      update-workers-amount:
        description: 'Amount of workers in update queue'
        default: '25'
        type: string
      deprovisioning-workers-amount:
        description: 'Amount of workers in deprovisioning queue'
        default: '25'
        type: string
      
      # Leak Detection Thresholds
      memory-growth-threshold-percent:
        description: 'Allowed memory growth percent (over baseline)'
        default: '70'
        type: string
      goroutine-increase-threshold:
        description: 'Allowed increase in goroutines (absolute)'
        default: '50'
        type: string
      fd-increase-threshold:
        description: 'Allowed increase in open file descriptors (absolute)'
        default: '10'
        type: string
      db-conn-increase-threshold:
        description: 'Allowed increase in DB connections (absolute)'
        default: '5'
        type: string

      # Release Configuration
      release:
        description: 'Determines if the workflow is called from release'
        default: 'false'
        type: string
      version:
        description: 'Release version'
        default: ''
        type: string

jobs:
  prepare-tests:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.k3s_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - id: get-version
        name: Get K3s version
        run: |
          VERSION=($(./scripts/testing/get-latest-k3s-releases.sh 1 | jq -r))
          echo "k3s_version=${VERSION}" >> "${GITHUB_OUTPUT}"

  run-concurrent-provisioning-test:
    runs-on: ubuntu-latest
    needs: prepare-tests
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Prepare K3s cluster and docker registry
        run: "./scripts/testing/k3s-setup.sh ${{ needs.prepare-tests.outputs.version }} --wait"
        
      - name: Build and push Docker images to k3s registry
        if: ${{ inputs.release == 'false' }}
        run: ./scripts/testing/build-and-push-images.sh PR-${{ inputs.version }}
        
      - name: Prepare values.yaml
        run: |
          yq e ".provisioning.maxStepProcessingTime = \"${{ inputs.provisioning-max-step-processing-time }}\"" -i resources/keb/values.yaml
          yq e ".provisioning.workersAmount = ${{ inputs.provisioning-workers-amount }}" -i resources/keb/values.yaml

      - name: Install KEB chart
        run: scripts/testing/install_keb.sh ${{ inputs.release }} ${{ inputs.version }}

      - name: Populate database
        run: scripts/testing/populate_performance_db.sh
          
      - name: Start metrics collector
        run: scripts/testing/start_metrics_collector.sh

      - name: Baseline monitoring period
        if: ${{ inputs.baseline-monitoring-minutes > 0 }}
        run: |
          scripts/testing/monitoring_period.sh ${{ inputs.baseline-monitoring-minutes }} "Baseline"
          scripts/testing/metrics_baseline_marker.sh

      - name: Provision instances
        run: |
          scripts/testing/provision_instances.sh ${{ inputs.instances-number }} 4deee563-e5ec-4731-b9b1-53b42d855f0c azure-cluster northeurope http://localhost:30080
          scripts/testing/assert_total_count.sh ${{ inputs.instances-number }} azure http://localhost:30080
      
      - name: Simulate KIM
        timeout-minutes: 60
        env:
          KIM_DELAY_SECONDS: ${{ inputs.kim-delay-seconds }}
        run: scripts/simulate_kim.sh
        
      - name: Post-test monitoring period (first round)
        if: ${{ inputs.post-test-monitoring-minutes > 0 }}
        run: scripts/testing/monitoring_period.sh ${{ inputs.post-test-monitoring-minutes }} "Post-test (first round)"

      - name: Mark baseline for leak detection before second round
        if: ${{ inputs.post-test-monitoring-minutes > 0 }}
        run: scripts/testing/metrics_baseline_marker.sh

      - name: Provision instances (second round)
        if: ${{ inputs.post-test-monitoring-minutes > 0 }}
        run: |
          scripts/testing/provision_instances.sh ${{ inputs.instances-number }} 4deee563-e5ec-4731-b9b1-53b42d855f0c azure-cluster northeurope http://localhost:30080
          scripts/testing/assert_total_count.sh $((2 * ${{ inputs.instances-number }})) azure http://localhost:30080
      
      - name: Simulate KIM (second round)
        if: ${{ inputs.post-test-monitoring-minutes > 0 }}
        timeout-minutes: 60
        env:
          KIM_DELAY_SECONDS: ${{ inputs.kim-delay-seconds }}
        run: scripts/simulate_kim.sh

      - name: Post-test monitoring period (second round)
        if: ${{ inputs.post-test-monitoring-minutes > 0 }}
        run: scripts/testing/monitoring_period.sh ${{ inputs.post-test-monitoring-minutes }} "Post-test (second round)"

      - name: Fetch metrics
        run: |
          scripts/testing/collect_provisioning_metrics.sh 4deee563-e5ec-4731-b9b1-53b42d855f0c
          scripts/generate_charts.sh

      - name: Set up Python
        if: ${{ inputs.post-test-monitoring-minutes > 0 }}
        uses: actions/setup-python@v6
        with:
          python-version: '3.9'

      - name: Analyze metrics for leaks
        if: ${{ inputs.post-test-monitoring-minutes > 0 }}
        run: |
          export MEMORY_GROWTH_THRESHOLD_PERCENT=${{ inputs.memory-growth-threshold-percent }}
          export GOROUTINE_INCREASE_THRESHOLD=${{ inputs.goroutine-increase-threshold }}
          export FD_INCREASE_THRESHOLD=${{ inputs.fd-increase-threshold }}
          export DB_CONN_INCREASE_THRESHOLD=${{ inputs.db-conn-increase-threshold }}
          python3 scripts/python/compare_performance_metrics.py

  run-concurrent-update-test:
    runs-on: ubuntu-latest
    needs: prepare-tests
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Prepare K3s cluster and docker registry
        run: "./scripts/testing/k3s-setup.sh ${{ needs.prepare-tests.outputs.version }} --wait"
        
      - name: Build and push Docker images to k3s registry
        if: ${{ inputs.release == 'false' }}
        run: ./scripts/testing/build-and-push-images.sh PR-${{ inputs.version }}

      - name: Prepare values.yaml
        run: |
          yq e ".provisioning.maxStepProcessingTime = \"${{ inputs.provisioning-max-step-processing-time }}\"" -i resources/keb/values.yaml
          yq e ".provisioning.workersAmount = ${{ inputs.provisioning-workers-amount }}" -i resources/keb/values.yaml
          yq e ".update.maxStepProcessingTime = \"${{ inputs.update-max-step-processing-time }}\"" -i resources/keb/values.yaml
          yq e ".update.workersAmount = ${{ inputs.update-workers-amount }}" -i resources/keb/values.yaml

      - name: Install KEB chart
        run: scripts/testing/install_keb.sh ${{ inputs.release }} ${{ inputs.version }}

      - name: Populate database
        run: scripts/testing/populate_performance_db.sh
          
      - name: Start metrics collector
        run: scripts/testing/start_metrics_collector.sh

      - name: Baseline monitoring period
        if: ${{ inputs.baseline-monitoring-minutes > 0 }}
        run: |
          scripts/testing/monitoring_period.sh ${{ inputs.baseline-monitoring-minutes }} "Baseline"
          scripts/testing/metrics_baseline_marker.sh

      - name: Provision instances
        run: |
          scripts/testing/provision_instances.sh ${{ inputs.instances-number }} 4deee563-e5ec-4731-b9b1-53b42d855f0c azure-cluster northeurope http://localhost:30080
          scripts/testing/assert_total_count.sh ${{ inputs.instances-number }} azure http://localhost:30080

      - name: Simulate KIM
        timeout-minutes: 60
        run: scripts/testing/simulate_kim_with_assertions.sh azure ${{ inputs.instances-number }} http://localhost:30080 0
        
      - name: Update instances
        timeout-minutes: 60
        run: |
          scripts/testing/update_instances.sh 4deee563-e5ec-4731-b9b1-53b42d855f0c azure autoScalerMax 15 http://localhost:30080
          scripts/testing/wait_for_all_operations.sh azure ${{ inputs.instances-number }} update http://localhost:30080

      - name: Fetch metrics
        run: scripts/testing/calculate_update_success_rate.sh 4deee563-e5ec-4731-b9b1-53b42d855f0c http://localhost:30080

      - name: Post-test monitoring period (first round)
        if: ${{ inputs.post-test-monitoring-minutes > 0 }}
        run: scripts/testing/monitoring_period.sh ${{ inputs.post-test-monitoring-minutes }} "Post-test (first round)"

      - name: Mark baseline for leak detection before second round
        if: ${{ inputs.post-test-monitoring-minutes > 0 }}
        run: |
          scripts/testing/metrics_baseline_marker.sh

      - name: Update instances (second round)
        if: ${{ inputs.post-test-monitoring-minutes > 0 }}
        timeout-minutes: 60
        run: |
          scripts/testing/update_instances.sh 4deee563-e5ec-4731-b9b1-53b42d855f0c azure autoScalerMax 16 http://localhost:30080
          scripts/testing/wait_for_all_operations.sh azure ${{ inputs.instances-number }} update http://localhost:30080
      
      - name: Fetch metrics
        run: scripts/testing/calculate_update_success_rate.sh 4deee563-e5ec-4731-b9b1-53b42d855f0c http://localhost:30080

      - name: Post-test monitoring period (second round)
        if: ${{ inputs.post-test-monitoring-minutes > 0 }}
        run: scripts/testing/monitoring_period.sh ${{ inputs.post-test-monitoring-minutes }} "Post-test (second round)"
      - name: Generate charts
        run: scripts/generate_charts.sh

      - name: Analyze metrics for leaks
        if: ${{ inputs.post-test-monitoring-minutes > 0 }}
        run: |
          export MEMORY_GROWTH_THRESHOLD_PERCENT=${{ inputs.memory-growth-threshold-percent }}
          export GOROUTINE_INCREASE_THRESHOLD=${{ inputs.goroutine-increase-threshold }}
          export FD_INCREASE_THRESHOLD=${{ inputs.fd-increase-threshold }}
          export DB_CONN_INCREASE_THRESHOLD=${{ inputs.db-conn-increase-threshold }}
          python3 scripts/python/compare_performance_metrics.py

  run-multiple-updates-on-a-single-instance-test:
    runs-on: ubuntu-latest
    needs: prepare-tests
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Prepare K3s cluster and docker registry
        run: "./scripts/testing/k3s-setup.sh ${{ needs.prepare-tests.outputs.version }} --wait"
        
      - name: Build and push Docker images to k3s registry
        if: ${{ inputs.release == 'false' }}
        run: ./scripts/testing/build-and-push-images.sh PR-${{ inputs.version }}

      - name: Prepare values.yaml
        run: |
          yq e ".update.maxStepProcessingTime = \"${{ inputs.update-max-step-processing-time }}\"" -i resources/keb/values.yaml
          yq e ".update.workersAmount = ${{ inputs.update-workers-amount }}" -i resources/keb/values.yaml

      - name: Install KEB chart
        run: scripts/testing/install_keb.sh ${{ inputs.release }} ${{ inputs.version }}

      - name: Populate database
        run: scripts/testing/populate_performance_db.sh
          
      - name: Start metrics collector
        run: scripts/testing/start_metrics_collector.sh

      - name: Baseline monitoring period
        if: ${{ inputs.baseline-monitoring-minutes > 0 }}
        run: |
          scripts/testing/monitoring_period.sh ${{ inputs.baseline-monitoring-minutes }} "Baseline"
          scripts/testing/metrics_baseline_marker.sh

      - name: Provision the instance
        run: scripts/testing/provision_instances.sh 1 azure-cluster 4deee563-e5ec-4731-b9b1-53b42d855f0c azure-cluster northeurope http://localhost:30080

      - name: Simulate KIM
        timeout-minutes: 60
        env:
          KIM_DELAY_SECONDS: 0
        run: |
          scripts/simulate_kim.sh
          scripts/testing/wait_for_instance_state.sh azure-cluster http://localhost:30080

      - name: Update the instance
        timeout-minutes: 60
        run: |
          scripts/testing/update_instance_multiple_times.sh azure-cluster 4deee563-e5ec-4731-b9b1-53b42d855f0c ${{ inputs.updates-number }} http://localhost:30080
          scripts/testing/wait_for_instance_state.sh azure-cluster http://localhost:30080

      - name: Post-test monitoring period (first round)
        if: ${{ inputs.post-test-monitoring-minutes > 0 }}
        run: scripts/testing/monitoring_period.sh ${{ inputs.post-test-monitoring-minutes }} "Post-test (first round)"

      - name: Mark baseline for leak detection before second round
        if: ${{ inputs.post-test-monitoring-minutes > 0 }}
        run: |
          scripts/testing/metrics_baseline_marker.sh

      - name: Update the instance (second round)
        if: ${{ inputs.post-test-monitoring-minutes > 0 }}
        timeout-minutes: 60
        run: |
          scripts/testing/update_instance_multiple_times.sh azure-cluster 4deee563-e5ec-4731-b9b1-53b42d855f0c ${{ inputs.updates-number }} http://localhost:30080
          scripts/testing/wait_for_instance_state.sh azure-cluster http://localhost:30080

      - name: Fetch metrics
        run: scripts/testing/calculate_update_success_rate.sh 4deee563-e5ec-4731-b9b1-53b42d855f0c http://localhost:30080

      - name: Post-test monitoring period (second round)
        if: ${{ inputs.post-test-monitoring-minutes > 0 }}
        run: scripts/testing/monitoring_period.sh ${{ inputs.post-test-monitoring-minutes }} "Post-test (second round)"

      - name: Generate charts
        run: scripts/generate_charts.sh

      - name: Set up Python
        if: ${{ inputs.post-test-monitoring-minutes > 0 }}
        uses: actions/setup-python@v6
        with:
          python-version: '3.9'

      - name: Analyze metrics for leaks
        if: ${{ inputs.post-test-monitoring-minutes > 0 }}
        run: |
          export MEMORY_GROWTH_THRESHOLD_PERCENT=${{ inputs.memory-growth-threshold-percent }}
          export GOROUTINE_INCREASE_THRESHOLD=${{ inputs.goroutine-increase-threshold }}
          export FD_INCREASE_THRESHOLD=${{ inputs.fd-increase-threshold }}
          export DB_CONN_INCREASE_THRESHOLD=${{ inputs.db-conn-increase-threshold }}
          python3 scripts/python/compare_performance_metrics.py

  run-concurrent-deprovisoning-test:
    runs-on: ubuntu-latest
    needs: prepare-tests
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Prepare K3s cluster and docker registry
        run: "./scripts/testing/k3s-setup.sh ${{ needs.prepare-tests.outputs.version }} --wait"
        
      - name: Build and push Docker images to k3s registry
        if: ${{ inputs.release == 'false' }}
        run: ./scripts/testing/build-and-push-images.sh PR-${{ inputs.version }}

      - name: Prepare values.yaml
        run: |
          yq e ".provisioning.maxStepProcessingTime = \"${{ inputs.provisioning-max-step-processing-time }}\"" -i resources/keb/values.yaml
          yq e ".provisioning.workersAmount = ${{ inputs.provisioning-workers-amount }}" -i resources/keb/values.yaml
          yq e ".deprovisioning.maxStepProcessingTime = \"${{ inputs.deprovisioning-max-step-processing-time }}\"" -i resources/keb/values.yaml
          yq e ".deprovisioning.workersAmount = ${{ inputs.deprovisioning-workers-amount }}" -i resources/keb/values.yaml

      - name: Install KEB chart
        run: scripts/testing/install_keb.sh ${{ inputs.release }} ${{ inputs.version }}

      - name: Populate database
        run: scripts/testing/populate_performance_db.sh
          
      - name: Start metrics collector
        run: scripts/testing/start_metrics_collector.sh

      - name: Provision instances (preparation for two deprovisioning rounds)
        run: |
          TOTAL_INSTANCES=$((${{ inputs.instances-number }} * 2))
          scripts/testing/provision_instances.sh $TOTAL_INSTANCES 4deee563-e5ec-4731-b9b1-53b42d855f0c azure-cluster northeurope http://localhost:30080
          scripts/testing/assert_total_count.sh $TOTAL_INSTANCES azure http://localhost:30080

      - name: Simulate KIM
        timeout-minutes: 60
        run: scripts/testing/simulate_kim_with_assertions.sh azure $((${{ inputs.instances-number }} * 2)) http://localhost:30080 0

      - name: Baseline monitoring period
        if: ${{ inputs.baseline-monitoring-minutes > 0 }}
        run: |
          scripts/testing/monitoring_period.sh ${{ inputs.baseline-monitoring-minutes }} "Baseline"
          scripts/testing/metrics_baseline_marker.sh

      - name: Deprovision first half of instances (first round)
        timeout-minutes: 60
        run: |
          scripts/testing/deprovision_instances.sh 4deee563-e5ec-4731-b9b1-53b42d855f0c azure http://localhost:30080 count ${{ inputs.instances-number }}
          scripts/testing/wait_for_all_operations.sh azure ${{ inputs.instances-number }} deprovisioning http://localhost:30080

      - name: Post-test monitoring period (first round)
        if: ${{ inputs.post-test-monitoring-minutes > 0 }}
        run: scripts/testing/monitoring_period.sh ${{ inputs.post-test-monitoring-minutes }} "Post-test (first round)"

      - name: Mark baseline for leak detection before second round
        if: ${{ inputs.post-test-monitoring-minutes > 0 }}
        run: scripts/testing/metrics_baseline_marker.sh

      - name: Deprovision remaining instances (second round)
        if: ${{ inputs.post-test-monitoring-minutes > 0 }}
        timeout-minutes: 60
        run: |
          scripts/testing/deprovision_instances.sh 4deee563-e5ec-4731-b9b1-53b42d855f0c azure http://localhost:30080
          scripts/testing/wait_for_all_operations.sh azure 0 deprovisioning http://localhost:30080

      - name: Post-test monitoring period (second round)
        if: ${{ inputs.post-test-monitoring-minutes > 0 }}
        run: scripts/testing/monitoring_period.sh ${{ inputs.post-test-monitoring-minutes }} "Post-test (second round)"

      - name: Fetch metrics
        run: scripts/testing/calculate_deprovision_metrics.sh 4deee563-e5ec-4731-b9b1-53b42d855f0c http://localhost:30080

      - name: Generate charts
        run: scripts/generate_charts.sh

      - name: Set up Python
        if: ${{ inputs.post-test-monitoring-minutes > 0 }}
        uses: actions/setup-python@v6
        with:
          python-version: '3.9'

      - name: Analyze metrics for leaks
        if: ${{ inputs.post-test-monitoring-minutes > 0 }}
        run: |
          export MEMORY_GROWTH_THRESHOLD_PERCENT=${{ inputs.memory-growth-threshold-percent }}
          export GOROUTINE_INCREASE_THRESHOLD=${{ inputs.goroutine-increase-threshold }}
          export FD_INCREASE_THRESHOLD=${{ inputs.fd-increase-threshold }}
          export DB_CONN_INCREASE_THRESHOLD=${{ inputs.db-conn-increase-threshold }}
          python3 scripts/python/compare_performance_metrics.py

  run-mixed-operations-test:
    runs-on: ubuntu-latest
    needs: prepare-tests
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Prepare K3s cluster and docker registry
        run: "./scripts/testing/k3s-setup.sh ${{ needs.prepare-tests.outputs.version }} --wait"
        
      - name: Build and push Docker images to k3s registry
        if: ${{ inputs.release == 'false' }}
        run: ./scripts/testing/build-and-push-images.sh PR-${{ inputs.version }}

      - name: Prepare values.yaml
        run: |
          yq e ".provisioning.maxStepProcessingTime = \"${{ inputs.provisioning-max-step-processing-time }}\"" -i resources/keb/values.yaml
          yq e ".provisioning.workersAmount = ${{ inputs.provisioning-workers-amount }}" -i resources/keb/values.yaml
          yq e ".update.maxStepProcessingTime = \"${{ inputs.update-max-step-processing-time }}\"" -i resources/keb/values.yaml
          yq e ".update.workersAmount = ${{ inputs.update-workers-amount }}" -i resources/keb/values.yaml
          yq e ".deprovisioning.maxStepProcessingTime = \"${{ inputs.deprovisioning-max-step-processing-time }}\"" -i resources/keb/values.yaml
          yq e ".deprovisioning.workersAmount = ${{ inputs.deprovisioning-workers-amount }}" -i resources/keb/values.yaml

      - name: Install KEB chart
        run: scripts/testing/install_keb.sh ${{ inputs.release }} ${{ inputs.version }}

      - name: Populate database
        run: scripts/testing/populate_performance_db.sh
          
      - name: Start metrics collector
        run: scripts/testing/start_metrics_collector.sh

      - name: Baseline monitoring period
        if: ${{ inputs.baseline-monitoring-minutes > 0 }}
        run: |
          scripts/testing/monitoring_period.sh ${{ inputs.baseline-monitoring-minutes }} "Baseline"
          scripts/testing/metrics_baseline_marker.sh

      - name: Provision instances
        run: |
          scripts/testing/provision_instances.sh ${{ inputs.instances-number }} 8cb22518-aa26-44c5-91a0-e669ec9bf443 azure-lite-cluster northeurope http://localhost:30080
          scripts/testing/assert_runtime_count.sh azure_lite ${{ inputs.instances-number }} http://localhost:30080
          scripts/testing/provision_instances.sh ${{ inputs.instances-number }} 4deee563-e5ec-4731-b9b1-53b42d855f0c azure-cluster northeurope http://localhost:30080
          scripts/testing/assert_runtime_count.sh azure ${{ inputs.instances-number }} http://localhost:30080
          
      - name: Simulate KIM
        timeout-minutes: 60
        env:
          KIM_DELAY_SECONDS: 0
        run: |
          scripts/simulate_kim.sh

          sleep 15
          
          scripts/testing/assert_runtime_count.sh azure_lite ${{ inputs.instances-number }} http://localhost:30080
          scripts/testing/assert_runtime_count.sh azure ${{ inputs.instances-number }} http://localhost:30080

      - name: Run mixed operations
        run: |
          # Provisioning requests

          scripts/testing/provision_instances.sh ${{ inputs.instances-number }} ca6e5357-707f-4565-bbbd-b3ab732597c6 gcp-cluster europe-west3 http://localhost:30080

          scripts/testing/assert_runtime_count.sh gcp ${{ inputs.instances-number }} http://localhost:30080
          
          # Update requests
          scripts/testing/update_instances.sh 8cb22518-aa26-44c5-91a0-e669ec9bf443 azure_lite autoScalerMax 15 http://localhost:30080
          
          # Deprovisioning requests
          scripts/testing/deprovision_instances.sh 4deee563-e5ec-4731-b9b1-53b42d855f0c azure http://localhost:30080
          
      - name: Simulate KIM
        timeout-minutes: 60
        env:
          KIM_DELAY_SECONDS: ${{ inputs.kim-delay-seconds }}
        run: scripts/simulate_kim.sh

      - name: Post-test monitoring period (first round)
        if: ${{ inputs.post-test-monitoring-minutes > 0 }}
        run: scripts/testing/monitoring_period.sh ${{ inputs.post-test-monitoring-minutes }} "Post-test (first round)"

      - name: Mark baseline for leak detection before second round
        if: ${{ inputs.post-test-monitoring-minutes > 0 }}
        run: |
          scripts/testing/metrics_baseline_marker.sh

      - name: Run mixed operations (second round)
        if: ${{ inputs.post-test-monitoring-minutes > 0 }}
        run: |
          # Provisioning requests
          scripts/testing/provision_instances.sh ${{ inputs.instances-number }} ca6e5357-707f-4565-bbbd-b3ab732597c6 gcp-cluster europe-west3 http://localhost:30080

          scripts/testing/assert_runtime_count.sh gcp $((2 * ${{ inputs.instances-number }})) http://localhost:30080
          
          # Update requests
          scripts/testing/update_instances.sh 8cb22518-aa26-44c5-91a0-e669ec9bf443 azure_lite autoScalerMax 16 http://localhost:30080
          
          # Deprovisioning requests
          scripts/testing/deprovision_instances.sh 4deee563-e5ec-4731-b9b1-53b42d855f0c azure http://localhost:30080
          
      - name: Simulate KIM (second round)
        if: ${{ inputs.post-test-monitoring-minutes > 0 }}
        timeout-minutes: 60
        env:
          KIM_DELAY_SECONDS: ${{ inputs.kim-delay-seconds }}
        run: scripts/simulate_kim.sh

      - name: Fetch metrics
        run: |
          sleep 15
          
          echo "### Provisioning Requests" >> $GITHUB_STEP_SUMMARY
          scripts/testing/collect_provisioning_metrics.sh ca6e5357-707f-4565-bbbd-b3ab732597c6
          
          echo "### Update Requests" >> $GITHUB_STEP_SUMMARY
          scripts/testing/calculate_update_success_rate.sh 8cb22518-aa26-44c5-91a0-e669ec9bf443 http://localhost:30080
          
          echo "### Deprovisioning Requests" >> $GITHUB_STEP_SUMMARY
          scripts/testing/calculate_deprovision_metrics.sh 4deee563-e5ec-4731-b9b1-53b42d855f0c http://localhost:30080

      - name: Post-test monitoring period (second round)
        if: ${{ inputs.post-test-monitoring-minutes > 0 }}
        run: scripts/testing/monitoring_period.sh ${{ inputs.post-test-monitoring-minutes }} "Post-test (second round)"

      - name: Generate charts
        run: scripts/generate_charts.sh

      - name: Set up Python
        if: ${{ inputs.post-test-monitoring-minutes > 0 }}
        uses: actions/setup-python@v6
        with:
          python-version: '3.9'

      - name: Analyze metrics for leaks
        if: ${{ inputs.post-test-monitoring-minutes > 0 }}
        run: |
          export MEMORY_GROWTH_THRESHOLD_PERCENT=${{ inputs.memory-growth-threshold-percent }}
          export GOROUTINE_INCREASE_THRESHOLD=${{ inputs.goroutine-increase-threshold }}
          export FD_INCREASE_THRESHOLD=${{ inputs.fd-increase-threshold }}
          export DB_CONN_INCREASE_THRESHOLD=${{ inputs.db-conn-increase-threshold }}
          python3 scripts/python/compare_performance_metrics.py

  run-runtimes-endpoint-test:
    runs-on: ubuntu-latest
    needs: prepare-tests
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Prepare K3s cluster and docker registry
        run: "./scripts/testing/k3s-setup.sh ${{ needs.prepare-tests.outputs.version }} --wait"
        
      - name: Build and push Docker images to k3s registry
        if: ${{ inputs.release == 'false' }}
        run: ./scripts/testing/build-and-push-images.sh PR-${{ inputs.version }}

      - name: Install KEB chart
        run: scripts/testing/install_keb.sh ${{ inputs.release }} ${{ inputs.version }}
          
      - name: Start metrics collector
        run: scripts/testing/start_metrics_collector.sh

      - name: Baseline monitoring period
        if: ${{ inputs.baseline-monitoring-minutes > 0 }}
        run: |
          scripts/testing/monitoring_period.sh ${{ inputs.baseline-monitoring-minutes }} "Baseline"
          scripts/testing/metrics_baseline_marker.sh
      - name: Fetch runtimes using GET endpoint
        run: |
          kubectl port-forward -n kcp-system deployment/postgres 5432:5432 &
          sleep 5
          
          DB_NAME=$(kubectl get secret kcp-postgresql -n kcp-system -o jsonpath="{.data.postgresql-broker-db-name}" | base64 -d)
          DB_USER=$(kubectl get secret kcp-postgresql -n kcp-system -o jsonpath="{.data.postgresql-broker-username}" | base64 -d)
          DB_PASS=$(kubectl get secret kcp-postgresql -n kcp-system -o jsonpath="{.data.postgresql-broker-password}" | base64 -d)
          
          PGPASSWORD=$DB_PASS psql -h localhost -p 5432 -U $DB_USER -d $DB_NAME -f resources/installation/migrations/populate_performance_tests_database.up.sql
          
          SUCCESS_COUNT=0
          for i in {1..100}; do
            STATUS_CODE=$(curl --write-out "%{http_code}" --silent --output /dev/null \
              --request GET \
              --url "http://localhost:30080/runtimes" \
              --header 'Content-Type: application/json' \
              --header 'X-Broker-API-Version: 2.16')
            if [[ "$STATUS_CODE" == "200" ]]; then
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            fi
          done
          SUCCESS_RATE=$((SUCCESS_COUNT * 100 / 100))
          echo "Success rate of runtimes requests: $SUCCESS_RATE%" >> $GITHUB_STEP_SUMMARY

          echo "<div align=\"center\">" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Number of Instances | Average Time per Page | Maximum Time per Page |" >> $GITHUB_STEP_SUMMARY
          echo "| :---: | :---: | :---: |" >> $GITHUB_STEP_SUMMARY

          fetch_and_measure() {
            local num_instances=$1
            local pages=$2

            TOTAL_TIME=0
            MAX_TIME=0

            for PAGE in $(seq 1 $pages); do
              START=$(date +%s%3N)
              curl --silent --request GET \
                --url "http://localhost:30080/runtimes?page=$PAGE" \
                --header 'Content-Type: application/json' \
                --header 'X-Broker-API-Version: 2.16' > /dev/null
              END=$(date +%s%3N)
              ELAPSED=$((END - START))
              TOTAL_TIME=$((TOTAL_TIME + ELAPSED))
              if (( ELAPSED > MAX_TIME )); then
                MAX_TIME=$ELAPSED
              fi
            done
            AVG_TIME=$((TOTAL_TIME / pages))

            echo "| $num_instances | $AVG_TIME ms | $MAX_TIME ms |" >> $GITHUB_STEP_SUMMARY
          }

          # 1k
          fetch_and_measure 1000 10

          # 10k
          for i in {1..9}; do
            PGPASSWORD=$DB_PASS psql -h localhost -p 5432 -U $DB_USER -d $DB_NAME -f resources/installation/migrations/populate_performance_tests_database.up.sql
          done
          fetch_and_measure 10000 100

          # 100k
          for i in {1..90}; do
            PGPASSWORD=$DB_PASS psql -h localhost -p 5432 -U $DB_USER -d $DB_NAME -f resources/installation/migrations/populate_performance_tests_database.up.sql
          done
          fetch_and_measure 100000 100

          echo "</div>" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          
          if [[ "$SUCCESS_RATE" != "100" ]]; then
            echo "Error: SUCCESS_RATE is $SUCCESS_RATE, expected 100"
            exit 1
          fi

      - name: Post-test monitoring period
        if: ${{ inputs.post-test-monitoring-minutes > 0 }}
        run: scripts/testing/monitoring_period.sh ${{ inputs.post-test-monitoring-minutes }} "Post-test"

      - name: Generate charts
        run: scripts/generate_charts.sh

      - name: Analyze metrics for leaks (disabled)
        if: ${{ inputs.post-test-monitoring-minutes > 0 }}
        run: |
          echo "Disabled"

  run-idle-monitoring-test:
    # Only run for nightly scheduled runs or manual workflow_dispatch, skip for PR/release
    if: ${{ inputs.release == 'true' && inputs.version == '' }}
    runs-on: ubuntu-latest
    needs: prepare-tests
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Prepare K3s cluster and docker registry
        run: "./scripts/testing/k3s-setup.sh ${{ needs.prepare-tests.outputs.version }} --wait"

      - name: Install KEB chart
        run: scripts/testing/install_keb.sh ${{ inputs.release }} ${{ inputs.version }}

      - name: Start metrics collector
        run: scripts/testing/start_metrics_collector.sh

      - name: First monitoring period (baseline)
        run: |
          DURATION=${{ inputs.baseline-monitoring-minutes }}
          if [ "$DURATION" -eq 0 ]; then
            DURATION=5
          fi
          scripts/testing/monitoring_period.sh $DURATION "First monitoring period (baseline)"

      - name: Second monitoring period (post-test)
        run: |
          DURATION=${{ inputs.post-test-monitoring-minutes }}
          if [ "$DURATION" -eq 0 ]; then
            DURATION=5
          fi
          scripts/testing/monitoring_period.sh $DURATION "Second monitoring period (post-test)"

      - name: Generate charts
        run: |
          sleep 15
          scripts/generate_charts.sh

      - name: Set up Python
        if: ${{ inputs.post-test-monitoring-minutes > 0 || inputs.baseline-monitoring-minutes > 0 }}
        uses: actions/setup-python@v6
        with:
          python-version: '3.9'

      - name: Analyze metrics for leaks (idle system)
        if: ${{ inputs.post-test-monitoring-minutes > 0 || inputs.baseline-monitoring-minutes > 0 }}
        run: |
          export MEMORY_GROWTH_THRESHOLD_PERCENT=${{ inputs.memory-growth-threshold-percent }}
          export GOROUTINE_INCREASE_THRESHOLD=${{ inputs.goroutine-increase-threshold }}
          export FD_INCREASE_THRESHOLD=${{ inputs.fd-increase-threshold }}
          export DB_CONN_INCREASE_THRESHOLD=${{ inputs.db-conn-increase-threshold }}
          python3 scripts/python/compare_performance_metrics.py